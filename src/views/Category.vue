<template>
  <section class="section">
    <div class="container" v-if="category">
      <div class="columns is-multiline">
        <div class="column is-one-quarter">
          <!--Category view checkbox-->
          <template>
            <div class="container">
              <aside class="menu">
                <div class="is-menu-checkbox has-background-light is-1 pt-4 pb-4 pl-2 pr-2">
                  <p class="menu-label has-text-centered">Productos por precio</p>
                  <ul class="menu-list">
                    <li class="has-text-centered">{{range}}€</li>
                    <li class="has-text-centered"><label><input type="range" v-model="range" min="0" max="600" step="1" /></label></li>
                  </ul>

                  <p class="menu-label has-text-centered">Stock</p>
                  <ul class="menu-list">
                    <li li class="pl-5"><label><input type="radio" v-model="filterStock" value="0"/> Sin Stock</label></li>
                    <li li class="pl-5"><label><input type="radio" v-model="filterStock" value="10000"/> Con Stock</label></li>
                  </ul>

                  <p class="menu-label has-text-centered">Ofertas</p>
                  <ul class="menu-list">
                    <li class="pl-5"><label><input type="radio" v-model="filterOffers" value="0"/> Sin ofertas</label></li>
                    <li class="pl-5"><label><input type="radio" v-model="filterOffers" value="10000"/> Con Ofertas</label></li>
                  </ul>
                </div>
              </aside>
            </div>
          </template>
        </div>
        <div class="column">
          <!--Category info-->
          <h1 class="title">{{ category.data.name }}</h1>
          <p>{{ category.data.description }}</p>
          <hr />
          <div class="level">
            <b-dropdown aria-role="list">
              <template #trigger="{ active }">
                <b-button label="Ordenar por" type="is-dark is-rounded is-small" :icon-right="active ? 'caret-up' : 'caret-down'" />
              </template>
              <b-dropdown-item aria-role="listitem" @click="filterBySortHighest">Precio: Más caros primero</b-dropdown-item>
              <b-dropdown-item aria-role="listitem" @click="filterBySortLowest">Precio: Más baratos primero</b-dropdown-item>
              <b-dropdown-item aria-role="listitem">Ofertas</b-dropdown-item>
            </b-dropdown>
          </div>
          <!-- Products -->
          <div class="columns is-multiline is-mobile" v-if="products">
            <ProductGrid v-for="(product, index) in filterProducts" :key="index" :product="product"  />
          </div>
        </div>
      </div>
    </div>
    <b-loading :is-full-page="true" v-model="isLoading" :can-cancel="false"></b-loading>
  </section>
</template>

<script>
import ProductGrid from '../components/products/ProductGrid.vue'

export default {
  name: 'Category',
  components: {
    ProductGrid
  },
  data () {
    return {
      category_id: this.$route.name,
      category: '',
      name: '',
      products: null,
      isLoading: true,
      range: 600,
      filterStock: Number.MAX_VALUE,
      filterOffers: Number.MAX_VALUE
    }
  },
  created () {
    this.getCategory()
    this.getCategoryProducts()
  },
  methods: {
    getCategory () {
      fetch(`/.netlify/functions/get-category/${this.category_id}`)
        .then((response) => response.json())
        .then((data) => {
          this.category = data
        })
        .catch((error) => console.log(error))
    },
    getCategoryProducts () {
      fetch(`/.netlify/functions/get-category-products/${this.category_id}`)
        .then((response) => response.json())
        .then((data) => {
          this.products = data.data
          this.isLoading = false
        })
        .catch((error) => console.log(error))
    },
    filterBySortLowest () {
      return this.products.sort((a, b) => (a.data.price > b.data.price))
    },
    filterBySortHighest () {
      return this.products.sort((a, b) => (a.data.price < b.data.price))
    },
    filterProductsByStock: function (products) {
      return products.filter(product => product.data.stock < this.filterStock)
    },
    filterProductsByOffers: function (products) {
      return products.filter(product => product.data.offers < this.filterOffers)
    },
    filterProductsByRange: function (products) {
      return products.filter(product => (product.data.price > 0 && product.data.price < this.range))
    },
    filterProductsByName: function (products) {
      return products.filter(product => !product.data.name.indexOf(this.name))
    }
  },
  computed: {
    filterProducts: function () {
      return this.filterProductsByStock(this.filterProductsByOffers(this.filterProductsByRange(this.filterProductsByName(this.products))))
    }
  }
}
</script>

<style>
.is-menu-checkbox {
  width: 180px;
  margin:auto;
  padding:auto;
  list-style: none;
}
</style>
